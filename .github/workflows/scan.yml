name: Endor Labs App Scans

on:
    push:
        branches: ["main", "release-**"]
    pull_request:
    workflow_dispatch:

env:
    PYTHON_VERSION: "3.13.11"

jobs:
    backend-build-and-test:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            id-token: write

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: "pip"

            # IMPORTANT: avoid setuptools 82 removing pkg_resources
            - name: Upgrade packaging tools
              run: |
                  python -m pip install -U "pip<26" "setuptools<82" wheel

            - name: Install Nox
              run: |
                  python -m pip install "nox>=2022"

            - name: Cache Nox virtualenvs
              uses: actions/cache@v4
              with:
                  path: .nox/
                  key: ${{ runner.os }}-nox-${{ hashFiles('noxfile.py') }}-${{ hashFiles('noxfiles/**.py') }}-${{ hashFiles('pyproject.toml') }}
                  restore-keys: |
                      ${{ runner.os }}-nox-

            # -------------------------------
            # CREATE PROJECT VENV FOR ENDOR
            # -------------------------------
            - name: Create project virtualenv
              run: |
                python -m venv .venv
                source .venv/bin/activate
                python -m pip install -U "pip<26" "setuptools<82" wheel
            
                # critical: avoid isolated build env pulling setuptools>=82
                python -m pip install --no-build-isolation -e .
            
                echo "VIRTUAL_ENV=$PWD/.venv" >> $GITHUB_ENV
                echo "$PWD/.venv/bin" >> $GITHUB_PATH

            # -------------------------------
            # ENDOR SCAN (now uses .venv)
            # -------------------------------
            - name: Endor Labs App Scans
              uses: endorlabs/github-action@main
              with:
                  namespace: "nate-learn"
                  scan_summary_output_type: "table"
                  pr: "false"
                  enable_github_action_token: "true"
                  scan_dependencies: "true"
                  scan_secrets: "true"
                  scan_git_logs: "true"
